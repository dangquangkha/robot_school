# --- ĐỊNH NGHĨA MÀU SẮC & BIẾN (Để dễ sửa) ---
#:set color_bg_sky      (0.53, 0.81, 0.98, 1)  # Màu xanh da trời nhạt
#:set color_btn_start   (1, 0.6, 0.2, 1)       # Màu cam rực rỡ
#:set color_btn_voice   (1, 0.4, 0.4, 1)       # Màu đỏ hồng
#:set color_btn_game    (0.2, 0.8, 0.2, 1)     # Màu xanh lá tươi
#:set color_btn_set     (0.4, 0.6, 1, 1)       # Màu xanh dương
#:set color_text_dark   (0.2, 0.2, 0.2, 1)     # Màu chữ xám đen dễ đọc

# --- ĐỊNH NGHĨA NÚT BẤM BO TRÒN (Custom Button) ---
# Trẻ em thích nút giống viên kẹo/bánh quy
# --- SỬA ĐỔI Ở ĐÂY: Xóa chữ @Button đi ---
# Vì đã khai báo class bên Python, ta chỉ cần định nghĩa giao diện
<KiddyButton>:
    background_color: 0, 0, 0, 0
    font_size: 20
    bold: True
    color: (1, 1, 1, 1)
    canvas.before:
        Color:
            # Code này bây giờ sẽ an toàn vì b_color đã được khởi tạo bên Python
            rgba: root.b_color if self.state == 'normal' else (root.b_color[0]*0.8, root.b_color[1]*0.8, root.b_color[2]*0.8, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [25,]

# --- QUẢN LÝ MÀN HÌNH ---
ScreenManager:
    WelcomeScreen:
    MainScreen:

# --- 1. MÀN HÌNH CHÀO (PHONG CÁCH HOẠT HÌNH) ---
<WelcomeScreen>:
    name: "welcome_screen"
    
    canvas.before:
        Color:
            rgba: color_bg_sky
        Rectangle:
            pos: self.pos
            size: self.size
        # Trang trí thêm hình tròn (giả đám mây) nếu muốn
        Color:
            rgba: 1, 1, 1, 0.3
        Ellipse:
            pos: self.width * 0.1, self.height * 0.6
            size: 100, 100

    BoxLayout:
        orientation: 'vertical'
        padding: 40
        spacing: 30
        
        # Spacer để đẩy nội dung vào giữa
        Widget:
            size_hint_y: 0.1

        Label:
            text: "ROBOT TRƯỜNG HỌC"
            font_size: 48
            bold: True
            color: (1, 1, 0, 1) # Màu vàng tươi
            outline_width: 2
            outline_color: (0, 0, 0, 1) # Viền đen cho chữ nổi bật

        Label:
            text: "Cùng chơi và học nhé!"
            font_size: 24
            color: color_text_dark
            size_hint_y: 0.2

        # Spacer
        Widget:
            size_hint_y: 0.1

        KiddyButton:

            text: "BẮT ĐẦU CHAT"
            size_hint: 0.8, None  # Chiếm 80% chiều ngang
            height: 90            # Nút cao, dễ bấm
            pos_hint: {'center_x': 0.5}
            b_color: color_btn_start
            font_size: 30

            # QUAN TRỌNG: Đặt on_release ở đây, thụt vào trong KiddyButton
            on_release: 
                root.manager.transition.direction = 'left'
                root.manager.current = "chat_screen"
            
            # --- THÊM NÚT NÀY VÀO ĐÂY ---
        Widget:
            size_hint_y: None
            height: 20  # Tạo khoảng cách nhỏ giữa 2 nút

        KiddyButton:
            text: "KHO GAME GIẢI TRÍ"
            size_hint: 0.8, None
            height: 90
            pos_hint: {'center_x': 0.5}
            b_color: color_btn_game  # Dùng màu xanh lá (đã định nghĩa ở đầu file)
            font_size: 30
            # Gọi hàm mới chúng ta vừa viết bên Python
            on_release: root.show_games_welcome()

            on_release: 
                root.manager.transition.direction = 'left'
                root.manager.current = "chat_screen"

        Widget:
            size_hint_y: 0.3

<MainScreen>:
    name: "chat_screen"

    # 1. BỐ CỤC XẾP CHỒNG
    FloatLayout:
        
        # --- LỚP 1: HÌNH NỀN (Màu trắng hoặc ảnh lớp học) ---
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1 
            Rectangle:
                pos: self.pos
                size: self.size
                source: 'images/Classroom_Day.png' # Bỏ dấu # nếu có ảnh nền

        # --- LỚP 2: NHÂN VẬT AI (Đã sửa lại dùng Opacity) ---
        FloatLayout:
            size_hint: 0.5, 0.9
            pos_hint: {'x': 0, 'bottom': 1}

            # 1. Ảnh tĩnh (Mặc định hiện)
            Image:
                id: face_idle
                source: 'images/idle.png'
                opacity: 1  # Hiện
                allow_stretch: True
                keep_ratio: True

            # 2. Ảnh nghe (Mặc định ẩn)
            Image:
                id: face_listen
                source: 'images/listening.gif'
                opacity: 0  # Ẩn
                anim_delay: 0.1
                allow_stretch: True
                keep_ratio: True

            # 3. Ảnh nói (Mặc định ẩn)
            Image:
                id: face_talk
                source: 'images/talking.gif'
                opacity: 0  # Ẩn
                anim_delay: 0.1
                allow_stretch: True
                keep_ratio: True

        # --- LỚP 3: KHUNG CHAT STREAM (Bên phải) ---
        BoxLayout:
            orientation: 'vertical'
            size_hint: 0.45, 0.9      # Chiếm 45% bề ngang
            pos_hint: {'right': 0.98, 'center_y': 0.5} # Căn lề phải
            padding: 15
            spacing: 10
            
            # Vẽ nền đen mờ (Giống khung chat game/stream)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.6 # Màu đen, độ trong suốt 60%
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20,]

            # Tiêu đề
            Label:
                text: "LIVE CHAT"
                font_size: 20
                bold: True
                color: 1, 0, 0, 1 # Chữ đỏ
                size_hint_y: None
                height: 30
                halign: 'left'
                text_size: self.size

            # Nội dung chat (Trôi lên)
            ScrollView:
                id: chat_scroller
                size_hint_y: 1
                
                Label:
                    id: chat_log
                    text: "Hệ thống: Đã kết nối..."
                    font_size: root.chat_font_size
                    color: 1, 1, 1, 1 # Chữ trắng
                    size_hint_y: None
                    height: self.texture_size[1]
                    text_size: self.width, None
                    valign: 'bottom'
                    markup: True

            # Nút bấm (Thu gọn)
            BoxLayout:
                size_hint_y: None
                height: 50
                spacing: 10

                # --- THÊM NÚT QUAY LẠI Ở ĐÂY ---
                KiddyButton:
                    text: "Quay lại"
                    font_size: 16
                    # Màu tím (Purple) cho nút thoát
                    b_color: (0.6, 0.4, 0.8, 1)
                    # Gọi hàm Python vừa viết
                    on_press: root.go_back_home()

                KiddyButton:
                    id: btn_voice
                    text: "Nói"
                    font_size: 16
                    b_color: color_btn_voice
                    on_press: root.toggle_voice_loop()

                KiddyButton:
                    text: "Game"
                    font_size: 16
                    b_color: color_btn_game
                    on_press: root.show_games()

                KiddyButton:
                    text: "Cài đặt"
                    font_size: 16
                    b_color: color_btn_set
                    on_press: root.open_settings()